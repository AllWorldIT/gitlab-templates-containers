image: docker:19.03.8
services:
  - docker:19.03.8-dind

stages:
  - build
  - test
  - release

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: /certs/client

before_script:
  - if [ -n "$GROUP_CI_REGISTRY_USER" -a -n "$GROUP_CI_REGISTRY_PASSWORD" ]; then echo "Group CI login..."; docker login -u "$GROUP_CI_REGISTRY_USER" -p "$GROUP_CI_REGISTRY_PASSWORD" registry.gitlab.iitsp.com/allworldit/docker; fi
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"

build:
  stage: build
  script:
    - set
    - if [ -n "$CI_BUILD_TAG" ]; then export CONTAINER_TEST_IMAGE="$CI_REGISTRY_IMAGE:$CI_BUILD_TAG"; VER=" $CI_BUILD_TAG"; else export CONTAINER_TEST_IMAGE="$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"; VER=""; fi
    - docker build --pull --build-arg=VERSION_INFO="$CI_PROJECT_TITLE [$CI_PROJECT_PATH_SLUG]$VER build $CI_BUILD_ID commit $CI_COMMIT_SHORT_SHA ($(date -Iseconds))" --tag "$CONTAINER_TEST_IMAGE" .
    # Branch tags are required for CI
    - docker push "$CONTAINER_TEST_IMAGE"

test:
  stage: test
  script:
    - if [ -n "$CI_BUILD_TAG" ]; then export CONTAINER_TEST_IMAGE="$CI_REGISTRY_IMAGE:$CI_BUILD_TAG"; else export CONTAINER_TEST_IMAGE="$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"; fi
    - docker pull "$CONTAINER_TEST_IMAGE"
    - docker run -e CI=true "$CONTAINER_TEST_IMAGE"

# Dated releases are only done for master
release-timestamp:
  stage: release
  script:
    - if [ -n "$CI_BUILD_TAG" ]; then export CONTAINER_TEST_IMAGE="$CI_REGISTRY_IMAGE:$CI_BUILD_TAG"; else export CONTAINER_TEST_IMAGE="$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"; fi
    - export CONTAINER_DATED_IMAGE="$CI_REGISTRY_IMAGE:$(date +%Y%m%d)"
    - docker pull "$CONTAINER_TEST_IMAGE"
    - docker tag "$CONTAINER_TEST_IMAGE" "$CONTAINER_DATED_IMAGE"
    - docker push "$CONTAINER_DATED_IMAGE"
  only:
    - master

# Releases are only done for the master repository, which maps to "latest"
release-latest:
  stage: release
  script:
    - if [ -n "$CI_BUILD_TAG" ]; then export CONTAINER_TEST_IMAGE="$CI_REGISTRY_IMAGE:$CI_BUILD_TAG"; else export CONTAINER_TEST_IMAGE="$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"; fi
    - export CONTAINER_RELEASE_IMAGE="$CI_REGISTRY_IMAGE:latest"
    - docker pull "$CONTAINER_TEST_IMAGE"
    - docker tag "$CONTAINER_TEST_IMAGE" "$CONTAINER_RELEASE_IMAGE"
    - docker push "$CONTAINER_RELEASE_IMAGE"
  only:
    - tags

